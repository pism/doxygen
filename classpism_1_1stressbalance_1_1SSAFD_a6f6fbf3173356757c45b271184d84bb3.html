<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PISM, A Parallel Ice Sheet Model: pism::stressbalance::SSAFD::solve</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="browser.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PISM, A Parallel Ice Sheet Model
   &#160;<span id="projectnumber">stable v2.0.6 committed by Constantine Khrulev on 2023-01-23 15:14:38 -0900</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="namespacepism.html">pism</a></li><li class="navelem"><a class="el" href="namespacepism_1_1stressbalance.html">stressbalance</a></li><li class="navelem"><a class="el" href="classpism_1_1stressbalance_1_1SSAFD.html">SSAFD</a></li>  </ul>
</div>
</div><!-- top -->
<div class="contents">
<table cellspacing="0" cellpadding="0" border="0">
  <tr>
   <td valign="top">
      <div class="navtab">
        <table>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a9d2b7c5f90521d04504265522a2be6d7.html#a9d2b7c5f90521d04504265522a2be6d7">assemble_matrix</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_afac389fdc315bc439e005e3cce9455f2.html#afac389fdc315bc439e005e3cce9455f2">assemble_rhs</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_ac56cf75960b044b73f59c7aa5b345fcb.html#ac56cf75960b044b73f59c7aa5b345fcb">compute_hardav_staggered</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a0654e01e3d5697a8c0547fb9f472855a.html#a0654e01e3d5697a8c0547fb9f472855a">compute_nuH_norm</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_abbbb1adc77fa2b9722a543d6393514e1.html#abbbb1adc77fa2b9722a543d6393514e1">compute_nuH_staggered</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a67bcf9c17456925e96edb8c0a118bd62.html#a67bcf9c17456925e96edb8c0a118bd62">compute_nuH_staggered_cfbc</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a87e9e9a348bee09c11300372f955c144.html#a87e9e9a348bee09c11300372f955c144">diagnostics_impl</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a69a42a64a3dee87e80b93f1b37216bab.html#a69a42a64a3dee87e80b93f1b37216bab">fracture_induced_softening</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a1a49a87a04ac088d559e0afd9ea4714c.html#a1a49a87a04ac088d559e0afd9ea4714c">init_impl</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a3dca9786800fd01c4851fe58160af737.html#a3dca9786800fd01c4851fe58160af737">integrated_viscosity</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_ab61a92f20ac00c24472d5d2ee89ab88a.html#ab61a92f20ac00c24472d5d2ee89ab88a">is_marginal</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a63a539865ddcfee6731be7b02f236e1c.html#a63a539865ddcfee6731be7b02f236e1c">m_A</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a68218a46dc65f5904cc0bcf4db2bdb55.html#a68218a46dc65f5904cc0bcf4db2bdb55">m_b</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_ae001c8ae24cc3802b94bba7e791b1628.html#ae001c8ae24cc3802b94bba7e791b1628">m_default_pc_failure_count</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a8f6b8b142bac406874e38eca21423e4a.html#a8f6b8b142bac406874e38eca21423e4a">m_default_pc_failure_max_count</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a7d9c2d1267dec19c9237fa4a20f3a843.html#a7d9c2d1267dec19c9237fa4a20f3a843">m_hardness</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a55b80bde7aa1a7a12e066d3ebd4000a5.html#a55b80bde7aa1a7a12e066d3ebd4000a5">m_KSP</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a8629c11857f8029ed3069b422ee6b1e3.html#a8629c11857f8029ed3069b422ee6b1e3">m_nuH</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a7802834c32716bc3d85a5465fa3b89b1.html#a7802834c32716bc3d85a5465fa3b89b1">m_nuH_old</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a3cdafe61ed987046f604233529e17a7e.html#a3cdafe61ed987046f604233529e17a7e">m_nuh_viewer</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_add6cca03cf4aa7ff955fe0e058acda53.html#add6cca03cf4aa7ff955fe0e058acda53">m_nuh_viewer_size</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a08f16aa7abf31982cb42039af9d6f3fe.html#a08f16aa7abf31982cb42039af9d6f3fe">m_scaling</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a0169525702647cb26a46304e7c8e1588.html#a0169525702647cb26a46304e7c8e1588">m_velocity_old</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_ae40dc5867b3c64f25cc558ca166d4344.html#ae40dc5867b3c64f25cc558ca166d4344">m_view_nuh</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a071f71830d71b6f4917df2e9892fe88d.html#a071f71830d71b6f4917df2e9892fe88d">m_work</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_aa4b0be7d0f659c52609217d9b424fbc7.html#aa4b0be7d0f659c52609217d9b424fbc7">pc_setup_asm</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_ad4e53c2bbfd4153fba786518129f1b7f.html#ad4e53c2bbfd4153fba786518129f1b7f">pc_setup_bjacobi</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_ac6f3c04fb21c297233aef96fe365595d.html#ac6f3c04fb21c297233aef96fe365595d">picard_iteration</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_ac8d24e3c1a5135f9f7c1967fc146ac8f.html#ac8d24e3c1a5135f9f7c1967fc146ac8f">picard_manager</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a1f9943b3e94a37b3315a16cd1b39d48d.html#a1f9943b3e94a37b3315a16cd1b39d48d">picard_strategy_regularization</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_afdf5c7d56a5d92c3fa1d0a7ed0a32c27.html#afdf5c7d56a5d92c3fa1d0a7ed0a32c27">set_diagonal_matrix_entry</a></td></tr>
          <tr><td class="navtabHL"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a6f6fbf3173356757c45b271184d84bb3.html#a6f6fbf3173356757c45b271184d84bb3">solve</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_ae914e6ecac4e9e39e99092ca68ae2339.html#ae914e6ecac4e9e39e99092ca68ae2339">SSAFD</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a5d769985920ee96990de18d5af2a4a7d.html#a5d769985920ee96990de18d5af2a4a7d">update_nuH_viewers</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a74dab45996979f9f12b63fe397b79e8b.html#a74dab45996979f9f12b63fe397b79e8b">write_system_petsc</a></td></tr>
          <tr><td class="navtab"><a class="navtab" href="classpism_1_1stressbalance_1_1SSAFD_a3faa51bfc09067172fae8c602aa15177.html#a3faa51bfc09067172fae8c602aa15177">~SSAFD</a></td></tr>
        </table>
      </div>
   </td>
   <td valign="top" class="mempage">
<a id="a6f6fbf3173356757c45b271184d84bb3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6f6fbf3173356757c45b271184d84bb3">&#9670;&nbsp;</a></span>solve()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void pism::stressbalance::SSAFD::solve </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classpism_1_1stressbalance_1_1Inputs.html">Inputs</a> &amp;&#160;</td>
          <td class="paramname"><em>inputs</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">protected</span><span class="mlabel">virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Compute the vertically-averaged horizontal velocity from the shallow shelf approximation. </p>
<p>This is the main procedure in the <a class="el" href="classpism_1_1stressbalance_1_1SSAFD.html" title="PISM&#39;s SSA solver: the finite difference implementation.">SSAFD</a>. It manages the nonlinear solve process and the Picard iteration.</p>
<p>The outer loop (over index <code>k</code>) is the nonlinear iteration. In this loop the effective viscosity is computed by <a class="el" href="classpism_1_1stressbalance_1_1SSAFD_abbbb1adc77fa2b9722a543d6393514e1.html#abbbb1adc77fa2b9722a543d6393514e1" title="Compute the product of ice thickness and effective viscosity (on the staggered grid).">compute_nuH_staggered()</a> and then the linear system is set up and solved.</p>
<p>Specifically, we call the PETSc procedure KSPSolve() to solve the linear system. Solving the linear system is also a loop, an iteration, but it occurs inside KSPSolve(). The user has full control of the KSP solve through the PETSc interface. The default choicess for KSP type <code>-ksp_type</code> and preconditioner type <code>-pc_type</code> are GMRES(30) for the former and block Jacobi with ILU on the blocks for the latter. The defaults usually work. These choices are important but poorly understood. The eigenvalues of the linearized <a class="el" href="classpism_1_1stressbalance_1_1SSA.html" title="PISM&#39;s SSA solver.">SSA</a> vary with ice sheet geometry and temperature in ways that are not well-studied. Nonetheless these eigenvalues determine the convergence of this (inner) linear iteration. A well-chosen preconditioner can put the eigenvalues in the right place so that the KSP can converge quickly.</p>
<p>The preconditioner will behave differently on different numbers of processors. If the user wants the results of <a class="el" href="classpism_1_1stressbalance_1_1SSA.html" title="PISM&#39;s SSA solver.">SSA</a> calculations to be independent of the number of processors, then <code>-pc_type none</code> could be used, but performance will be poor.</p>
<p>If you want to test different KSP methods, it may be helpful to see how many iterations were necessary. Use <code>-ksp_monitor</code>. Initial testing implies that CGS takes roughly half the iterations of GMRES(30), but is not significantly faster because the iterations are each roughly twice as slow. The outputs of PETSc options <code>-ksp_monitor_singular_value</code>, <code>-ksp_compute_eigenvalues</code> and <code>-ksp_plot_eigenvalues -draw_pause N</code> (the last holds plots for N seconds) may be useful to diagnose.</p>
<p>The outer loop terminates when the effective viscosity times thickness is no longer changing much, according to the tolerance set by the option <code>-ssafd_picard_rtol</code>. The outer loop also terminates when a maximum number of iterations is exceeded. We save the velocity from the last time step in order to have a better estimate of the effective viscosity than the u=v=0 result.</p>
<p>In truth there is an "outer outer" loop (over index <code>l</code>). This attempts to over-regularize the effective viscosity if the nonlinear iteration (the "outer" loop over <code>k</code>) is not converging with the default regularization. The same over-regularization is attempted if the KSP object reports that it has not converged.</p>
<p>(An alternative for recovery in the KSP diverged case, suggested by Jed, is to revert to a direct linear solve, either for the whole domain (not scalable) or on the subdomains. This recovery alternative requires a more nontrivial choice but it may be worthwhile. Note the user can already do <code>-pc_type asm -sub_pc_type lu</code> at the command line, forcing subdomain direct solves.)</p>
<p>FIXME: update this doxygen comment </p>

<p>Implements <a class="el" href="classpism_1_1stressbalance_1_1SSA_a21ab19c399db633d8260d81a9e8bc8db.html#a21ab19c399db633d8260d81a9e8bc8db">pism::stressbalance::SSA</a>.</p>

<p class="definition">Definition at line <a class="el" href="SSAFD_8cc_source.html#l00928">928</a> of file <a class="el" href="SSAFD_8cc_source.html">SSAFD.cc</a>.</p>

<p class="reference">References <a class="el" href="SSAFD_8cc_source.html#l00245">assemble_rhs()</a>, <a class="el" href="SSAFD_8cc_source.html#l01262">compute_hardav_staggered()</a>, <a class="el" href="IceModelVec2_8hh_source.html#l00097">pism::IceModelVec2&lt; T &gt;::copy_from()</a>, <a class="el" href="exactTestP_8cc_source.html#l00045">pism::k</a>, <a class="el" href="Component_8hh_source.html#l00138">pism::Component::m_config</a>, <a class="el" href="Component_8hh_source.html#l00142">pism::Component::m_log</a>, <a class="el" href="ShallowStressBalance_8hh_source.html#l00083">pism::stressbalance::ShallowStressBalance::m_velocity</a>, <a class="el" href="SSAFD_8hh_source.html#l00114">m_velocity_old</a>, <a class="el" href="SSAFD_8cc_source.html#l00981">picard_iteration()</a>, <a class="el" href="SSAFD_8cc_source.html#l01192">picard_strategy_regularization()</a>, <a class="el" href="error__handling_8hh_source.html#l00044">PISM_ERROR_LOCATION</a>, <a class="el" href="iceModelVec_8cc_source.html#l00252">pism::IceModelVec::scale()</a>, <a class="el" href="iceModelVec_8cc_source.html#l00669">pism::IceModelVec::update_ghosts()</a>, and <a class="el" href="SSAFD_8cc_source.html#l01722">write_system_petsc()</a>.</p>

</div>
</div>
    </td>
  </tr>
</table>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
